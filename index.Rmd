--- 
title: "HR_Sales_Bookdown"
author: "Miguel Rodicio Honrado"
date: "03-02-2026"
site: bookdown::bookdown_site
---
# Methods

In this project, we want to analyse two dataset. The first dataset we are going to use is related with the sales of a shop from September 2023 until September 2024, and the main idea is to look for the principal income of the shop, from which item we can obtain more money or which is the less bought item . The second dataset is related with the workers of data and HR-department of an industry, we can look for important resources such us Gender, Years at the Company, Job Level and the income of the worker.

## Plotting amounts

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE
)

library(tidyverse)
library(scales)
library(ggforce)
library(ggrepel)
library(treemapify)
```

We want to see the amount of money earned in the store with the different products offered. With this, although we would still need to analyze the price we pay to have that product in the store, we can consider which product brings us the most money and which one brings us the least. For this we first group the colums Product type and we sum the total price of that product and, after that, we separate it into the different categories for the barplot.

```{r}
sales_data <- read_csv("data/Electronic_sales_Sep2023-Sep2024.csv")
hr_data <- read_csv("Data/HR-Employee-Attrition.csv")

money_by_product <- sales_data %>%
  group_by(`Product Type`) %>%
  summarise(total_sales = sum(`Total Price`)) %>%
  ungroup()

ggplot(money_by_product,
       aes(x = fct_reorder(`Product Type`, total_sales),
           y = total_sales)) +
  geom_col(fill = "blue") +
  coord_flip() +
  scale_y_continuous(labels = label_comma()) +
  labs(
    title = "Total Sales of each Product Type",
    x = "Product Type",
    y = "Total Sales"
  )
```

It is also important to know which payment methods generate the most profit for us in order to identify those associated with higher purchase amounts. To do this, we calculated the mean and the median, since the mean can be affected by outliers, while the median is more robust. Thanks to this, we observed that the methods with the highest spending per purchase are PayPal and bank transfer. However, we can also see how outliers affect the mean, as it increases relatively compared to the median by about 250 per sale.

```{r}
sales_payment <- sales_data %>%
  group_by(`Payment Method`) %>%
  summarise(
    mean_price = mean(`Total Price`, na.rm = TRUE),
    median_price = median(`Total Price`, na.rm = TRUE)
  ) %>%
  pivot_longer(
    cols = c(mean_price, median_price),
    names_to = "Statistic",
    values_to = "Value"
  )

ggplot(sales_payment,
       aes(x = fct_reorder(`Payment Method`, Value),
           y = Value,
           color = Statistic)) +
  geom_point(size = 5) +
  coord_flip() +
  scale_y_continuous(labels = label_comma()) +
  labs(
    title = "Mean and Median Price by Payment Method",
    x = "Payment Method",
    y = "Total Price"
  )
```

## Proportions

Another important data that we should work with it is the different shipping methods in the store. So we consider that a pie chart is suitable for the case. In the graph we can see that the most used method is the "Standard" with about 33.6% of the shipping. However we can observe that the other faster methods are balanced with about 16% each. This gives us the conclusion that customers prefer the cheapest shipping methods despite that the others are faster than the Standar.

```{r}
orders_by_shipping <- sales_data %>%
  count(`Shipping Type`) %>% 
  mutate(
    fraction = n / sum(n),
    label = paste0(`Shipping Type`, "\n", n, " (", scales::percent(fraction), ")")
  )

ggplot(orders_by_shipping, aes(x = "", y = n, fill = label)) +
  geom_bar(stat = "identity", width = 1, color = "white") +
  coord_polar(theta = "y") +
  labs(
    title = "Orders by Shipping Type",
    fill = "Shipping Type"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    legend.position = "right"
  )

```
Now we should look for the most sold products (not the ones that gives us the more income) and we can relate with the first graph. As we can observe, the most sold item are smartphones that matches with the first graph. We can also see that tablet, laptop and smart watch are really similar, however the one that produces the second better income are the smart watches while here we can see that the second most sold item are the tablets. Finally the less sold item are the headphones which are also the items with the less income.

```{r}
orders_by_product <- sales_data %>%
  count(`Product Type`)

ggplot(orders_by_product, aes(
  area = n,
  fill = `Product Type`,
  label = paste0(`Product Type`, "\n", n)
)) +
  geom_treemap() +
  geom_treemap_text(
    colour = "white",
    place = "left",
    grow = TRUE
  ) +
  labs(title = "Orders by Product Type")

```

## Distributions

Now we will analyse the different purchases by men and women. In this graph we can see that the sales are balanced between them and we can not observe big difference in any product. The smartphone continues to be the most sold item despite of the gender with approximately 3000 sales from each gender. We can observe a little difference in the headphones, where male tends to buy more than female, however female customers tends to buy more smatwatches. 
```{r}
sales_mirror <- sales_data %>%
  group_by(`Product Type`, Gender) %>%
  summarise(n_orders = n(), .groups = "drop") %>%
  mutate(
    n_orders_mirror = ifelse(Gender == "Male", -n_orders, n_orders)
  )

ggplot(sales_mirror, aes(x = `Product Type`, y = n_orders_mirror, fill = Gender)) +
  geom_bar(data = subset(sales_mirror, Gender == "Male"),
           aes(x = `Product Type`, y = n_orders_mirror),
           stat = "identity", alpha = 0.6, fill = "blue") +
  geom_bar(data = subset(sales_mirror, Gender == "Female"),
           aes(x = `Product Type`, y = n_orders_mirror),
           stat = "identity", alpha = 0.6, fill = "pink") +
  geom_text(aes(label = n_orders),
            data = sales_mirror,
            position = position_stack(vjust = 0.5),
            color = "white") +
  scale_y_continuous(labels = function(x) scales::label_comma()(abs(x))) +
  labs(
    title = "Purchases by Product Type for each Gender",
    x = "Product Type",
    y = "Number of Orders"
  )
```
This density plot represents the total price per purchase by gender. We can see that both graphs are really similar and we can find in both cases an asymmetrical graph to the left. We observe that despite male or female, the highest concentration of sales are for low purchases (between 0 and 2000) with less ones to the right. Looking at this graph we can suggest that gender does not have any significant influence on the total amount spend.

```{r}
sales_clean <- sales_data %>%
  filter(!is.na(Gender) & Gender != "#N/A")

ggplot(sales_clean, aes(x = `Total Price`, fill = Gender)) +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c("Male" = "blue", "Female" = "pink")) +
  scale_x_continuous(labels = scales::label_comma()) +
  labs(
    title = "Density of Total Purchases by Gender",
    x = "Total Price",
    y = "Density",
    fill = "Gender"
  ) +
  facet_wrap(~Gender, ncol = 1) + 
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold")
    )
```
## Trends

This is a graph that shows the average total sales of a day during the year. In the first months (from oct 2023 - january 2024) we can see that sales are a little bit low compared with the rest of the months but the graph tends to increase during the months (steady upward). Maybe this is because seasonal effects or marketing campaigns.

```{r}
sales_daily <- sales_data %>%
  mutate(Purchase_Date = as.Date(`Purchase Date`)) %>%
  group_by(Purchase_Date) %>%
  summarise(
    avg_spent = mean(`Total Price`, na.rm = TRUE),
    .groups = "drop"
  )

ggplot(sales_daily, aes(x = Purchase_Date, y = avg_spent)) +
  geom_point(alpha = 0.3) +
  labs(
    title = "Average Daily Sales",
    x = "Purchase Date",
    y = "Average Total Price"
  ) +
  theme_minimal()
```
Despite is not the same graph but very similar, we can observe the difference of the average spend in female and male. For this we will work with the mean values. For the first months, we can observe that female tends to spend a more than male. However during the 6 last months it stays equal with a small difference in some days.

```{r}
sales_daily_gender <- sales_data %>%
  filter(Gender %in% c("Male", "Female")) %>%
  mutate(Purchase_Date = as.Date(`Purchase Date`)) %>%
  group_by(Purchase_Date, Gender) %>%
  summarise(
    avg_spent = mean(`Total Price`, na.rm = TRUE),
    .groups = "drop"
  )

ggplot(sales_daily_gender,
       aes(x = Purchase_Date, y = avg_spent, color = Gender)) +
  geom_point(alpha = 0.25) +
  geom_smooth(method = "loess", span = 0.2, se = FALSE) +
  theme_minimal()
```

## Distributions 2

Thanks to this boxplot we can observe the monthly income related with the years at the company and we can confirm that it is directly related one with each other. We can observe that the mean of each category is higher than the previous one and the graph tends to increase over the years. There are also some outliers in most of the categories but they are not relevant. The last category increase extremely compared with the previous one, with a mean value of about 17000. Also the whiskers becomes larger with the past of the years, this can mean that during the years the workers are more distributed by their salary and Job Level.

```{r}
hr_dist <- hr_data %>%
  mutate(
    YearsGroup = cut(
      YearsAtCompany,
      breaks = c(0, 2, 5, 10, 20, 40),
      labels = c("0–2", "3–5", "6–10", "11–20", "20+"),
      right = FALSE
    )
  ) %>%
  filter(!is.na(YearsGroup))
  
ggplot(hr_dist, aes(x = YearsGroup, y = MonthlyIncome)) +
  geom_boxplot(outlier.alpha = 0.3) +
  scale_y_continuous(labels = scales::label_comma()) +
  labs(
    title = "Monthly Income vs Years at Company",
    x = "Years at Company",
    y = "Monthly Income"
  ) +
  theme_minimal()
```
This violin diagram shows us that a higher Job Level is directly related to a better income. We can obtain rally useful information in every Leval. For the first one we can see that the violin is narrower and concentrated, indicating that most employees earn monstly the same. In the second level. Job levels 2, 3, and 4 are similar. We observe that they are longer and than the first one and this is because in this levels are more distribution of job roles (categories). Finally we observe that the concentration of the last one is really dense, indicating that the income is very concentrated and there are not too much job roles.

```{r}
hr_violin <- hr_data %>%
  mutate(JobLevel = factor(JobLevel))

ggplot(hr_violin, aes(x = JobLevel, y = MonthlyIncome)) +
  geom_violin(fill = "steelblue", alpha = 0.7, trim = FALSE) +
  scale_y_continuous(labels = scales::label_comma()) +
  labs(
    title = "Monthly Income vs Job Level",
    x = "Job Level",
    y = "Monthly Income"
  ) +
  theme_minimal()

```


## Visualizing uncertaintly

```{r}
hr_summary_years <- hr_data %>%
  filter(!is.na(MonthlyIncome) & !is.na(YearsAtCompany)) %>%
  group_by(YearsAtCompany) %>%
  summarise(
    mean_income = mean(MonthlyIncome),
    sd_income = sd(MonthlyIncome),
    n = n(),
    se_income = sd_income / sqrt(n),
    ci_low = mean_income - 1.96 * se_income,
    ci_high = mean_income + 1.96 * se_income
  ) %>%
  ungroup() %>%
  arrange(YearsAtCompany)

ggplot(hr_summary_years, aes(x = mean_income, y = YearsAtCompany)) +
  geom_point(size = 3, color = "darkgreen") +
  geom_errorbarh(aes(xmin = ci_low, xmax = ci_high), height = 0.3, color = "darkgreen") +
  scale_x_continuous(labels = scales::label_comma()) +
  labs(
    title = "Mean Monthly Income by Years at Company (95% CI)",
    x = "Mean Monthly Income",
    y = "Years at Company"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))
```

```{r}
hr_plot <- hr_data %>%
  filter(!is.na(MonthlyIncome) & !is.na(JobLevel))
ggplot(hr_plot, aes(x = JobLevel, y = MonthlyIncome)) +
  geom_jitter(width = 0.2, height = 0, alpha = 0.3, color = "steelblue") +
  geom_smooth(method = "lm", se = TRUE, level = 0.80,
              aes(fill = "80% CI"), color = "lightgreen", alpha = 0.2, linewidth = 1.1) +
  geom_smooth(method = "lm", se = TRUE, level = 0.95,
              aes(fill = "95% CI"), color = "indianred", alpha = 0.2, linewidth = 1.1) +
  geom_smooth(method = "lm", se = TRUE, level = 0.99,
              aes(fill = "99% CI"), color = "lightblue", alpha = 0.1, linewidth = 1.1) +
  scale_fill_manual(name = "Confidence Interval",
                    values = c("80% CI" = "green",
                               "95% CI" = "red",
                               "99% CI" = "blue")) +
  scale_y_continuous(labels = scales::label_comma()) +
  scale_x_continuous(breaks = unique(hr_plot$JobLevel)) +
  labs(
    title = "Monthly Income vs Job Level with CI",
    x = "Job Level",
    y = "Monthly Income"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))
```


